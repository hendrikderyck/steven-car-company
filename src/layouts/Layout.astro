---
import '../styles/global.css';
import { reviews } from '../data/reviews';

interface Props {
  title: string;
  description?: string;
  headerDark?: boolean;
}

const { title, description = "Steven Car Company BV – Aan- en verkoop van jonge occasions in Ninove. Eerlijk, persoonlijk, kwaliteit. Overname mogelijk. Bel 0487 45 03 31.", headerDark = false } = Astro.props;
const pathname = Astro.url.pathname;

// Function to get 3 reviews per page based on pathname
function getReviewsForPage(pathname: string, allReviews: typeof reviews): typeof reviews {
  // Create a simple hash from the pathname
  let hash = 0;
  for (let i = 0; i < pathname.length; i++) {
    const char = pathname.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // Convert to 32-bit integer
  }
  
  // Use absolute value and modulo to get starting index
  const startIndex = Math.abs(hash) % allReviews.length;
  
  // Return 3 reviews starting from the calculated index (with wrapping)
  const pageReviews: typeof reviews = [];
  for (let i = 0; i < 3; i++) {
    const index = (startIndex + i) % allReviews.length;
    pageReviews.push(allReviews[index]);
  }
  
  return pageReviews;
}

const pageReviews = getReviewsForPage(pathname, reviews);

const nav = [
  { href: "/", label: "Home" },
  { href: "/aanbod/", label: "Aanbod" },
  { href: "/overname/", label: "Overname" },
  { href: "/over-ons/", label: "Over Ons" },
  { href: "/contact/", label: "Contact" },
];

function isActive(href: string): boolean {
  if (href === "/") return pathname === "/" || pathname === "";
  return pathname.startsWith(href);
}

const addressQuery = encodeURIComponent("Aalstersesteenweg 511A, 9400 Ninove, België");
const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${addressQuery}`;
---

<!doctype html>
<html lang="nl-BE">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="/logo.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet" />
    <title>{title}</title>
  </head>
  <body>
    <div class:list={["min-h-screen flex flex-col", headerDark ? "bg-black" : "bg-bg"]}>
      <header id="site-header" class="header-monolith">
        <div class="header-inner">
          <a href="/" class="header-logo-link">
            <img src="/logo.png" alt="Steven Car Company BV" class="header-logo" />
          </a>
          <nav class="header-nav">
            {nav.map(({ href, label }) => {
              const active = isActive(href);
              return (
                <a
                  href={href}
                  class:list={["header-nav-link", active && "header-nav-link-active"]}
                >
                  {label}
                  {active && <span class="header-nav-link-underline" aria-hidden="true" />}
                </a>
              );
            })}
          </nav>
          <a href="tel:0487450331" class="header-cta">
            <span class="header-cta-label">Bel nu</span>
            <span>0487 45 03 31</span>
          </a>
        </div>
        <div class="header-mobile-nav">
          {nav.map(({ href, label }) => (
            <a
              href={href}
              class:list={["header-mobile-link", isActive(href) && "header-mobile-link-active"]}
            >
              {label}
            </a>
          ))}
        </div>
      </header>
      <main class="flex-1">
        <slot />
        <!-- Social proof: links 5 sterren, rechts carousel recensies -->
        <section class="site-social-proof" id="site-social-proof" aria-label="Recensies klanten">
          <div class="site-social-proof-inner">
            <div class="site-social-proof-left" id="site-social-proof-left">
              <div class="site-social-proof-stars" id="site-social-proof-stars" aria-hidden="true">
                <svg class="site-social-proof-star" data-star viewBox="0 0 24 24" fill="currentColor" aria-hidden><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" /></svg>
                <svg class="site-social-proof-star" data-star viewBox="0 0 24 24" fill="currentColor" aria-hidden><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" /></svg>
                <svg class="site-social-proof-star" data-star viewBox="0 0 24 24" fill="currentColor" aria-hidden><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" /></svg>
                <svg class="site-social-proof-star" data-star viewBox="0 0 24 24" fill="currentColor" aria-hidden><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" /></svg>
                <svg class="site-social-proof-star" data-star viewBox="0 0 24 24" fill="currentColor" aria-hidden><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" /></svg>
              </div>
              <p class="site-social-proof-score" id="site-social-proof-score">5,0</p>
              <p class="site-social-proof-label" id="site-social-proof-label">op AutoScout24</p>
              <a href="https://www.autoscout24.be/nl/verkopers/steven-car-company-bv" target="_blank" rel="noopener noreferrer" class="site-social-proof-cta" id="site-social-proof-cta">Alle reviews</a>
            </div>
            <div class="site-social-proof-right" id="site-social-proof-right">
              <div class="site-reviews-carousel" role="region" aria-label="Recensies">
                <div class="site-reviews-wrapper">
                  <div class="site-reviews-track" id="site-reviews-track">
                    {pageReviews.map((review) => (
                      <blockquote class="site-review-card">
                        <p class="site-review-text">{review.text}</p>
                        <footer class="site-review-footer">
                          <cite class="site-review-author">{review.author}</cite>
                          <span class="site-review-date">{review.date}</span>
                        </footer>
                      </blockquote>
                    ))}
                    {pageReviews.map((review) => (
                      <blockquote class="site-review-card" aria-hidden="true">
                        <p class="site-review-text">{review.text}</p>
                        <footer class="site-review-footer">
                          <cite class="site-review-author">{review.author}</cite>
                          <span class="site-review-date">{review.date}</span>
                        </footer>
                      </blockquote>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>
      <footer class="footer-monolith">
        <div class="footer-inner">
          <div class="footer-main">
            <a href="/" class="footer-brand">
              <img src="/logo.png" alt="Steven Car Company BV" class="footer-logo" />
            </a>
            <div class="footer-block">
              <span class="footer-label">Contact</span>
              <a href={mapsUrl} target="_blank" rel="noopener noreferrer" class="footer-address">Aalstersesteenweg 511A<br />9400 Ninove</a>
              <a href="tel:0487450331" class="footer-phone">0487 45 03 31</a>
            </div>
            <nav class="footer-block footer-sitemap" aria-label="Sitemap">
              <span class="footer-label">Sitemap</span>
              <div class="footer-links">
                {nav.map(({ href, label }) => (
                  <a href={href} class="footer-sitemap-link">{label}</a>
                ))}
              </div>
            </nav>
          </div>
          <div class="footer-bar">
            <span class="footer-copyright">© {new Date().getFullYear()} Steven Car Company BV</span>
          </div>
        </div>
      </footer>
    </div>

    <style is:global>
      /* —— Header: Pitch Black & White · Stealth Monolith (always visible) —— */
      .header-monolith {
        position: sticky;
        top: 0;
        z-index: 50;
        background: #000000;
        border-bottom: 1px solid rgba(255, 255, 255, 0.12);
        transform: none;
      }
      .header-inner {
        max-width: 72rem;
        margin-left: auto;
        margin-right: auto;
        padding: 0 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 4rem;
        overflow: visible;
      }
      @media (min-width: 640px) {
        .header-inner { padding-left: 1.5rem; padding-right: 1.5rem; }
      }
      .header-logo-link {
        display: flex;
        align-items: center;
        margin: -0.5rem 0;
      }
      @media (min-width: 640px) {
        .header-logo-link { margin: -0.75rem 0; }
      }
      .header-logo {
        height: 5rem;
        width: auto;
        object-fit: contain;
        filter: invert(1);
      }
      @media (min-width: 640px) {
        .header-logo { height: 6rem; }
      }
      .header-nav {
        display: none;
      }
      @media (min-width: 768px) {
        .header-nav {
          display: flex;
          align-items: center;
          gap: 2.5rem;
        }
      }
      .header-nav-link {
        position: relative;
        font-family: var(--font-body);
        font-size: 0.875rem;
        font-weight: 500;
        color: #FFFFFF;
        text-decoration: none;
        padding: 0.25rem 0;
        transition: opacity 0.2s ease;
      }
      .header-nav-link:hover { opacity: 0.85; }
      .header-nav-link-active { font-weight: 700; }
      .header-nav-link-underline {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: #FFFFFF;
      }
      .header-nav-link:focus-visible,
      .header-mobile-link:focus-visible,
      .header-cta:focus-visible {
        outline: 1px solid #FFFFFF;
        outline-offset: 2px;
      }
      .header-cta {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1rem;
        border-radius: 0;
        background: #FFFFFF;
        color: #000000;
        font-family: var(--font-display);
        font-weight: 700;
        font-size: 0.875rem;
        letter-spacing: 0.04em;
        text-decoration: none;
        transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        border: 1px solid #FFFFFF;
        flex-shrink: 0;
      }
      .header-cta:hover {
        background: transparent;
        color: #FFFFFF;
        border-color: #FFFFFF;
      }
      .header-cta-label { display: none; }
      @media (min-width: 640px) {
        .header-cta-label { display: inline; }
      }
      .header-mobile-nav {
        display: flex;
        gap: 1.5rem;
        padding: 0.75rem 1rem;
        overflow-x: auto;
        border-top: 1px solid rgba(255, 255, 255, 0.12);
      }
      @media (min-width: 768px) {
        .header-mobile-nav { display: none; }
      }
      .header-mobile-link {
        font-size: 0.875rem;
        white-space: nowrap;
        font-family: var(--font-body);
        color: #FFFFFF;
        text-decoration: none;
        transition: opacity 0.2s ease;
      }
      .header-mobile-link:hover { opacity: 0.85; }
      .header-mobile-link-active { font-weight: 700; }

      /* —— Footer: Pitch Black & White · Stealth Monolith —— */
      .footer-monolith {
        background: #000000;
        color: #FFFFFF;
      }
      .footer-inner {
        max-width: 72rem;
        margin-left: auto;
        margin-right: auto;
        padding: 0 1rem;
      }
      @media (min-width: 640px) {
        .footer-inner { padding-left: 1.5rem; padding-right: 1.5rem; }
      }
      .footer-main {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
        padding: 3rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.12);
      }
      @media (min-width: 768px) {
        .footer-main {
          grid-template-columns: auto 1fr auto;
          gap: 3rem;
          align-items: start;
          padding: 4rem 0;
        }
      }
      .footer-brand {
        display: block;
        width: fit-content;
      }
      .footer-logo {
        height: 2.25rem;
        width: auto;
        object-fit: contain;
        filter: invert(1);
        display: block;
      }
      .footer-block {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .footer-label {
        font-family: var(--font-display);
        font-size: 0.6875rem;
        font-weight: 700;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: #FFFFFF;
        margin-bottom: 0.25rem;
      }
      .footer-address {
        font-family: var(--font-body);
        font-size: 0.875rem;
        line-height: 1.6;
        color: #FFFFFF;
        margin: 0;
        text-decoration: none;
        display: inline-block;
        transition: opacity 0.2s ease;
      }
      .footer-address:hover { opacity: 0.85; }
      .footer-address:focus-visible {
        outline: 1px solid #FFFFFF;
        outline-offset: 2px;
      }
      .footer-phone {
        font-family: var(--font-display);
        font-weight: 700;
        font-size: 0.875rem;
        color: #FFFFFF;
        text-decoration: none;
        margin-top: 0.25rem;
        transition: opacity 0.2s ease;
      }
      .footer-phone:hover { opacity: 0.85; }
      .footer-phone:focus-visible {
        outline: 1px solid #FFFFFF;
        outline-offset: 2px;
      }
      .footer-sitemap {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .footer-links {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem 1.5rem;
        margin-top: 0.25rem;
      }
      .footer-sitemap-link {
        font-family: var(--font-body);
        font-size: 0.875rem;
        color: #FFFFFF;
        text-decoration: none;
        transition: opacity 0.2s ease;
      }
      .footer-sitemap-link:hover { opacity: 0.85; }
      .footer-sitemap-link:focus-visible {
        outline: 1px solid #FFFFFF;
        outline-offset: 2px;
      }
      .footer-bar {
        padding: 1.25rem 0;
        text-align: center;
        border-top: none;
      }
      .footer-copyright {
        font-family: var(--font-body);
        font-size: 0.75rem;
        letter-spacing: 0.02em;
        color: rgba(255, 255, 255, 0.6);
      }

      /* —— Social proof: links sterren, rechts carousel (modern) —— */
      .site-social-proof {
        width: 100%;
        padding: 3.5rem 1.25rem 4rem;
        background: #f5f5f5;
        color: #0a0a0a;
      }
      @media (min-width: 640px) {
        .site-social-proof { padding: 4rem 2rem 5rem; }
      }
      @media (min-width: 1024px) {
        .site-social-proof { padding: 5rem 2.5rem 6rem; }
      }
      .site-social-proof-inner {
        max-width: 72rem;
        margin-left: auto;
        margin-right: auto;
        display: grid;
        gap: 2.5rem;
        align-items: center;
      }
      @media (min-width: 1024px) {
        .site-social-proof-inner {
          grid-template-columns: minmax(200px, 280px) 1fr;
          gap: 4rem;
        }
      }
      .site-social-proof-left {
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
      }
      @media (min-width: 1024px) {
        .site-social-proof-left { align-items: flex-start; text-align: left; }
      }
      .site-social-proof-stars {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.25rem;
      }
      @media (min-width: 1024px) {
        .site-social-proof-stars { justify-content: flex-start; }
      }
      .site-social-proof-star {
        width: 1.5rem;
        height: 1.5rem;
        color: #fbbf24;
      }
      @media (min-width: 640px) {
        .site-social-proof-star { width: 1.75rem; height: 1.75rem; }
      }
      .site-social-proof-score {
        font-family: var(--font-display);
        font-size: 2rem;
        font-weight: 800;
        letter-spacing: -0.02em;
        color: #0a0a0a;
        margin: 0;
        line-height: 1;
      }
      @media (min-width: 640px) {
        .site-social-proof-score { font-size: 2.5rem; }
      }
      .site-social-proof-label {
        font-family: var(--font-body);
        font-size: 0.875rem;
        color: rgba(10, 10, 10, 0.65);
        margin: 0;
      }
      .site-social-proof-cta {
        display: inline-block;
        font-family: var(--font-display);
        font-size: 0.8125rem;
        font-weight: 700;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        color: #0a0a0a;
        text-decoration: none;
        margin-top: 0.5rem;
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(10, 10, 10, 0.4);
        transition: border-color 0.2s ease, color 0.2s ease;
      }
      .site-social-proof-cta:hover {
        border-color: #0a0a0a;
        color: #0a0a0a;
      }
      .site-social-proof-cta:focus-visible {
        outline: 1px solid #0a0a0a;
        outline-offset: 3px;
      }
      .site-social-proof-right {
        min-width: 0;
        width: 100%;
      }
      .site-reviews-carousel {
        width: 100%;
      }
      .site-reviews-wrapper {
        overflow: hidden;
        width: 100%;
        position: relative;
        mask-image: linear-gradient(
          to right,
          transparent 0%,
          black 5%,
          black 95%,
          transparent 100%
        );
        -webkit-mask-image: linear-gradient(
          to right,
          transparent 0%,
          black 5%,
          black 95%,
          transparent 100%
        );
      }
      .site-reviews-track {
        display: flex;
        gap: 1.5rem;
        animation: site-reviews-scroll 12s ease-in-out infinite;
        will-change: transform;
      }
      @keyframes site-reviews-scroll {
        0%, 25% {
          transform: translateX(0);
        }
        30%, 50% {
          transform: translateX(calc(-100vw + 1.5rem));
        }
        55%, 75% {
          transform: translateX(calc(-200vw + 3rem));
        }
        80%, 100% {
          transform: translateX(0);
        }
      }
      @media (min-width: 363px) {
        @keyframes site-reviews-scroll {
          0%, 25% {
            transform: translateX(0);
          }
          30%, 50% {
            transform: translateX(calc(-320px - 1.5rem));
          }
          55%, 75% {
            transform: translateX(calc(-640px - 3rem));
          }
          80%, 100% {
            transform: translateX(0);
          }
        }
      }
      @media (min-width: 640px) {
        @keyframes site-reviews-scroll {
          0%, 25% {
            transform: translateX(0);
          }
          30%, 50% {
            transform: translateX(calc(-340px - 1.5rem));
          }
          55%, 75% {
            transform: translateX(calc(-680px - 3rem));
          }
          80%, 100% {
            transform: translateX(0);
          }
        }
      }
      .site-review-card {
        flex: 0 0 auto;
        width: calc(100vw - 3rem);
        max-width: 320px;
        min-width: 280px;
        margin: 0;
        padding: 1.75rem 1.5rem;
        background: #ffffff;
        border: 1px solid rgba(10, 10, 10, 0.1);
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
      }
      @media (min-width: 640px) {
        .site-review-card {
          width: 340px;
          min-width: 340px;
          padding: 2rem 1.75rem;
        }
      }
      @media (min-width: 1024px) {
        .site-reviews-wrapper {
          mask-image: linear-gradient(
            to right,
            transparent 0%,
            black 2%,
            black 98%,
            transparent 100%
          );
          -webkit-mask-image: linear-gradient(
            to right,
            transparent 0%,
            black 2%,
            black 98%,
            transparent 100%
          );
        }
      }
      .site-review-text {
        font-family: var(--font-body);
        font-size: 0.9375rem;
        line-height: 1.6;
        color: rgba(10, 10, 10, 0.9);
        margin: 0;
        flex: 1;
      }
      .site-review-footer {
        margin-top: 1.25rem;
        display: flex;
        flex-wrap: wrap;
        align-items: baseline;
        gap: 0.5rem 1rem;
      }
      .site-review-author {
        font-family: var(--font-display);
        font-size: 0.875rem;
        font-weight: 700;
        font-style: normal;
        color: #0a0a0a;
      }
      .site-review-date {
        font-family: var(--font-body);
        font-size: 0.8125rem;
        color: rgba(10, 10, 10, 0.5);
      }
    </style>

    <script>
      import gsap from 'gsap';
      import { ScrollTrigger } from 'gsap/ScrollTrigger';

      gsap.registerPlugin(ScrollTrigger);

      function initSocialProofAnimations() {
        const section = document.getElementById('site-social-proof');
        const stars = document.querySelectorAll('[data-star]');
        const score = document.getElementById('site-social-proof-score');
        const label = document.getElementById('site-social-proof-label');
        const cta = document.getElementById('site-social-proof-cta');
        const track = document.getElementById('site-reviews-track');
        const reviewCards = track?.querySelectorAll('.site-review-card');

        if (!section) return;

        const ease = 'power3.out';

        // —— Initial states ——
        gsap.set(stars, { scale: 0, rotation: -180, opacity: 0 });
        gsap.set(score, { opacity: 0, scale: 0.8, y: 12 });
        gsap.set(label, { opacity: 0, y: 8 });
        gsap.set(cta, { opacity: 0, y: 8 });
        gsap.set(reviewCards, { opacity: 0, y: 24, scale: 0.96 });

        // —— Scroll-triggered animation ——
        ScrollTrigger.create({
          trigger: section,
          start: 'top 85%',
          onEnter: () => {
            // Stars: stagger scale + rotation
            gsap.to(stars, {
              scale: 1,
              rotation: 0,
              opacity: 1,
              duration: 0.5,
              stagger: 0.08,
              ease: 'back.out(1.4)',
            });

            // Score: count up from 0 to 5.0
            gsap.to(score, {
              opacity: 1,
              scale: 1,
              y: 0,
              duration: 0.5,
              ease,
            });
            const scoreObj = { value: 0 };
            gsap.to(scoreObj, {
              value: 5.0,
              duration: 1.2,
              ease: 'power2.out',
              onUpdate: () => {
                if (score) {
                  score.textContent = scoreObj.value.toFixed(1).replace('.', ',');
                }
              },
            });

            // Label: fade up
            gsap.to(label, {
              opacity: 1,
              y: 0,
              duration: 0.4,
              delay: 0.3,
              ease,
            });

            // CTA: fade up
            gsap.to(cta, {
              opacity: 1,
              y: 0,
              duration: 0.4,
              delay: 0.4,
              ease,
            });

            // Review cards: stagger fade up
            gsap.to(reviewCards, {
              opacity: 1,
              y: 0,
              scale: 1,
              duration: 0.5,
              stagger: 0.1,
              delay: 0.2,
              ease,
            });
          },
        });

        // —— CTA hover ——
        if (cta) {
          const hoverTl = gsap.timeline({ paused: true });
          hoverTl.to(cta, { y: -2, duration: 0.2, ease: 'power2.out' });
          cta.addEventListener('mouseenter', () => hoverTl.play());
          cta.addEventListener('mouseleave', () => hoverTl.reverse());
        }

        // —— Stars hover: subtle pulse ——
        stars.forEach((star) => {
          const hoverTl = gsap.timeline({ paused: true });
          hoverTl.to(star, { scale: 1.15, rotation: 12, duration: 0.25, ease: 'power2.out' });
          star.addEventListener('mouseenter', () => hoverTl.play());
          star.addEventListener('mouseleave', () => hoverTl.reverse());
        });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initSocialProofAnimations);
      } else {
        initSocialProofAnimations();
      }
    </script>
  </body>
</html>
