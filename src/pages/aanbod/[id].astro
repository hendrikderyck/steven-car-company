---
import Layout from '../../layouts/Layout.astro';
import '../../styles/as24-detail.css';
import { fetchAllListingUrls, extractIdFromListingUrl, extractSlugFromListingUrl } from '../../utils/listings';
import { fetchDetailPageHtml } from '../../utils/listing-detail';

export async function getStaticPaths() {
  const listingUrls = await fetchAllListingUrls();
  const paths: { params: { id: string }; props: { listingUrl: string } }[] = [];
  for (const listingUrl of listingUrls) {
    const uuid = extractIdFromListingUrl(listingUrl);
    const slug = extractSlugFromListingUrl(listingUrl);
    paths.push({ params: { id: uuid }, props: { listingUrl } });
    if (slug !== uuid) {
      paths.push({ params: { id: slug }, props: { listingUrl } });
    }
  }
  return paths;
}

const { listingUrl } = Astro.props;

// Ensure listingUrl is available
if (!listingUrl) {
  throw new Error(`No listingUrl provided for ID: ${Astro.params.id}`);
}

let detail: Awaited<ReturnType<typeof fetchDetailPageHtml>>;
try {
  detail = await fetchDetailPageHtml(listingUrl);
  
  // Check if content is empty or too short (likely extraction failed)
  if (!detail.contentHtml || detail.contentHtml.trim().length < 100) {
    console.warn(`Content extraction may have failed for ${listingUrl}. Content length: ${detail.contentHtml?.length || 0}`);
    detail.contentHtml = `<div class="p-4"><p class="text-muted">Kon detailpagina niet volledig laden. <a href="${listingUrl}" target="_blank" rel="noopener noreferrer">Bekijk op AutoScout24</a></p></div>`;
  }
} catch (e) {
  console.error(`Error fetching detail page for ${listingUrl}:`, e);
  detail = {
    title: 'Voertuig',
    contentHtml: `<div class="p-4"><p class="text-muted">Kon detailpagina niet laden. <a href="${listingUrl}" target="_blank" rel="noopener noreferrer">Bekijk op AutoScout24</a></p></div>`,
    listingUrl,
    images: [],
    price: undefined,
    keySpecs: [],
  };
}
const pageTitle = `${detail.title} – Steven Car Company BV`;
---

<Layout title={pageTitle} description={detail.title}>
  <section class="bg-bg py-4 border-b border-border">
    <div class="max-w-6xl mx-auto px-4 sm:px-6">
      <a href="/aanbod/" class="font-body text-sm text-muted hover:text-ink transition">← Terug naar aanbod</a>
    </div>
  </section>
  <section class="py-6 sm:py-10 bg-surface">
    <div class="max-w-6xl mx-auto px-4 sm:px-6">
      <div class:list={["detail-hero", !(detail.images && detail.images.length > 0) && "detail-hero-no-gallery"]}>
        {detail.images && detail.images.length > 0 && (
          <aside class="detail-gallery" data-image-count={detail.images.length}>
            <div class="detail-gallery-main-wrap">
              <div class="detail-gallery-main">
                <img
                  src={detail.images[0]}
                  alt={detail.title}
                  class="detail-gallery-img"
                  width="720"
                  height="540"
                  loading="eager"
                  fetchpriority="high"
                  tabIndex={0}
                />
              </div>
              {detail.images.length > 1 && (
                <>
                  <button type="button" class="detail-gallery-arrow detail-gallery-arrow-prev" aria-label="Vorige afbeelding">
                    <span aria-hidden="true">‹</span>
                  </button>
                  <button type="button" class="detail-gallery-arrow detail-gallery-arrow-next" aria-label="Volgende afbeelding">
                    <span aria-hidden="true">›</span>
                  </button>
                </>
              )}
            </div>
            {detail.images.length > 1 && (
              <div class="detail-gallery-thumbs">
                {detail.images.map((src, i) => (
                  <button
                    type="button"
                    class="detail-gallery-thumb"
                    data-index={i}
                    aria-label={`Afbeelding ${i + 1}`}
                  >
                    <img src={src} alt="" width="120" height="90" loading="lazy" />
                  </button>
                ))}
              </div>
            )}
          </aside>
        )}
        <div class="detail-summary">
          <h1 class="detail-summary-title">
            {(() => {
              const pipeIndex = detail.title.indexOf('|');
              if (pipeIndex > 0) {
                const firstPart = detail.title.substring(0, pipeIndex).trim();
                const rest = detail.title.substring(pipeIndex).trim();
                return (
                  <>
                    <strong>{firstPart}</strong>
                    <br />
                    {rest}
                  </>
                );
              }
              return detail.title;
            })()}
          </h1>
          <div class="detail-under-construction">
            <p>Deze pagina is momenteel in aanbouw.</p>
            <p>Binnenkort vindt u hier alle details over dit voertuig.</p>
          </div>
        </div>
      </div>
      {/* Lightbox */}
      {detail.images && detail.images.length > 0 && (
        <div class="detail-gallery-lightbox" id="detail-gallery-lightbox" aria-hidden="true">
          <button type="button" class="detail-gallery-lightbox-close" aria-label="Sluiten">×</button>
          <button type="button" class="detail-gallery-lightbox-prev" aria-label="Vorige afbeelding">‹</button>
          <div class="detail-gallery-lightbox-img-wrap">
            <img src="" alt="" class="detail-gallery-lightbox-img" id="detail-gallery-lightbox-img" />
          </div>
          <button type="button" class="detail-gallery-lightbox-next" aria-label="Volgende afbeelding">›</button>
        </div>
      )}
    </div>
  </section>
  {detail.images && detail.images.length > 0 && (
    <script define:vars={{ imageUrls: detail.images }}>
      (function () {
        const gallery = document.querySelector('.detail-gallery');
        if (!gallery) return;
        const mainWrap = gallery.querySelector('.detail-gallery-main-wrap');
        const mainImg = gallery.querySelector('.detail-gallery-img');
        const thumbs = Array.from(gallery.querySelectorAll('.detail-gallery-thumb'));
        const lightbox = document.getElementById('detail-gallery-lightbox');
        const lightboxImg = document.getElementById('detail-gallery-lightbox-img');
        const lightboxPrev = lightbox?.querySelector('.detail-gallery-lightbox-prev');
        const lightboxNext = lightbox?.querySelector('.detail-gallery-lightbox-next');
        const lightboxClose = lightbox?.querySelector('.detail-gallery-lightbox-close');
        const images = Array.isArray(imageUrls) && imageUrls.length ? imageUrls : thumbs.map((t) => t.querySelector('img')?.src).filter(Boolean);
        let currentIndex = 0;

        function setIndex(i) {
          if (images.length === 0) return;
          currentIndex = (i + images.length) % images.length;
          if (mainImg) mainImg.src = images[currentIndex];
          thumbs.forEach((t, idx) => t.classList.toggle('is-active', idx === currentIndex));
          const activeThumb = thumbs[currentIndex];
          if (activeThumb) activeThumb.scrollIntoView({ block: 'nearest', inline: 'center', behavior: 'smooth' });
          if (lightbox?.classList.contains('is-open') && lightboxImg) lightboxImg.src = images[currentIndex];
        }

        thumbs.forEach((btn) => {
          btn.addEventListener('click', () => {
            const idx = parseInt(btn.getAttribute('data-index') ?? '0', 10);
            setIndex(idx);
          });
        });
        thumbs[0]?.classList.add('is-active');

        const prevBtn = mainWrap?.querySelector('.detail-gallery-arrow-prev');
        const nextBtn = mainWrap?.querySelector('.detail-gallery-arrow-next');
        prevBtn?.addEventListener('click', () => setIndex(currentIndex - 1));
        nextBtn?.addEventListener('click', () => setIndex(currentIndex + 1));

        mainImg?.addEventListener('click', () => {
          if (images.length === 0 || !lightbox || !lightboxImg) return;
          lightboxImg.src = images[currentIndex];
          lightbox.setAttribute('aria-hidden', 'false');
          lightbox.classList.add('is-open');
          document.body.style.overflow = 'hidden';
        });

        function closeLightbox() {
          if (!lightbox) return;
          lightbox.classList.remove('is-open');
          lightbox.setAttribute('aria-hidden', 'true');
          document.body.style.overflow = '';
        }

        lightboxClose?.addEventListener('click', closeLightbox);
        lightbox?.addEventListener('click', (e) => { if (e.target === lightbox) closeLightbox(); });
        document.addEventListener('keydown', (e) => {
          if (!lightbox?.classList.contains('is-open')) return;
          if (e.key === 'Escape') closeLightbox();
          else if (e.key === 'ArrowLeft') setIndex(currentIndex - 1);
          else if (e.key === 'ArrowRight') setIndex(currentIndex + 1);
        });
        lightboxPrev?.addEventListener('click', (e) => { e.stopPropagation(); setIndex(currentIndex - 1); });
        lightboxNext?.addEventListener('click', (e) => { e.stopPropagation(); setIndex(currentIndex + 1); });
      })();
    </script>
  )}
</Layout>
